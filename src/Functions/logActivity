import { createClientFromRequest } from 'npm:@base44/sdk@0.5.0';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        // Verify authentication
        const currentUser = await base44.auth.me();
        if (!currentUser) {
            return new Response(JSON.stringify({ error: 'Unauthorized' }), { 
                status: 401, 
                headers: { 'Content-Type': 'application/json' } 
            });
        }

        const activityData = await req.json();
        
        // Create the activity log entry
        const activity = await base44.entities.Activity.create({
            ...activityData,
            created_by: currentUser.email
        });

        return new Response(JSON.stringify({ 
            success: true, 
            activity: activity 
        }), { 
            status: 200, 
            headers: { 'Content-Type': 'application/json' } 
        });
        
    } catch (error) {
        console.error("Error logging activity:", error);
        return new Response(JSON.stringify({ 
            error: 'Failed to log activity', 
            details: error.message 
        }), { 
            status: 500, 
            headers: { 'Content-Type': 'application/json' } 
        });
    }
});